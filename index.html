<!DOCTYPE html>
<html>
<head>
    <title>Spotify Group Session</title>
    <link rel="stylesheet" href="styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div id="app">
        <div id="loading" class="screen">
            <div class="spinner"></div>
            <p>Connecting to Spotify...</p>
        </div>
        
        <div id="error" class="screen hidden">
            <h1>Error</h1>
            <p id="error-message"></p>
            <button onclick="window.location.reload()">Try Again</button>
        </div>

        <div id="auth" class="screen hidden">
            <h1>Join Group Session</h1>
            <p>Click below to connect your Spotify account</p>
            <button id="auth-button">Connect Spotify</button>
        </div>

        <div id="success" class="screen hidden">
            <h1>Successfully Connected!</h1>
            <p>Here's your friend code - send this to your friend:</p>
            <div class="code-container">
                <code id="friend-code"></code>
                <button id="copy-code">Copy Code</button>
            </div>
            <p class="note">After sending the code, you can close this window.</p>
        </div>
    </div>
    <script>
        const config = {
            clientId: 'bb39de3fd45d476880f0373663e4a751',
            redirectUri: window.location.origin + window.location.pathname,
            scopes: [
                'user-read-private',
                'user-read-email',
                'user-library-read',
                'user-top-read',
                'user-read-recently-played'
            ].join(' ')
        };

        // Spotify Authorization Flow
        async function handleAuth() {
            const params = new URLSearchParams({
                client_id: config.clientId,
                response_type: 'code',
                redirect_uri: config.redirectUri,
                scope: config.scopes,
                state: localStorage.getItem('sessionData') // Pass session data as state
            });

            window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
        }

        // Handle the Spotify callback
        async function handleCallback(code, state) {
            try {
                // Generate a unique code combining session data and authorization code
                const friendCode = btoa(JSON.stringify({
                    auth: code,
                    session: state,
                    timestamp: Date.now()
                }));

                // Show the success screen with the code
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('success').classList.remove('hidden');
                document.getElementById('friend-code').textContent = friendCode;

                // Add copy button functionality
                document.getElementById('copy-code').addEventListener('click', () => {
                    navigator.clipboard.writeText(friendCode).then(() => {
                        document.getElementById('copy-code').textContent = 'Copied!';
                        setTimeout(() => {
                            document.getElementById('copy-code').textContent = 'Copy Code';
                        }, 2000);
                    });
                });
            } catch (error) {
                showError('Failed to process authorization');
            }
        }

        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }

        // Initial load handler
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.has('code')) {
                // Handle Spotify callback
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                handleCallback(code, state);
            } else if (urlParams.has('session')) {
                // Store session data and show auth screen
                localStorage.setItem('sessionData', urlParams.get('session'));
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('auth').classList.remove('hidden');
                
                // Add click handler for auth button
                document.getElementById('auth-button').addEventListener('click', handleAuth);
            } else {
                showError('Invalid invitation link');
            }
        });
    </script>
</body>
</html>
