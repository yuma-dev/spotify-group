<!DOCTYPE html>
<html>
<head>
    <title>Spotify Group Session</title>
    <link rel="stylesheet" href="styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div id="app">
        <div id="loading" class="screen">
            <div class="spinner"></div>
            <p>Connecting to Spotify...</p>
        </div>
        
        <div id="error" class="screen hidden">
            <h1>Error</h1>
            <p id="error-message"></p>
            <button onclick="window.location.reload()">Try Again</button>
        </div>

        <div id="auth" class="screen hidden">
            <h1>Join Group Session</h1>
            <p>Click below to connect your Spotify account</p>
            <button id="auth-button">Connect Spotify</button>
        </div>

        <div id="success" class="screen hidden">
            <h1>Successfully Connected!</h1>
            <p>Here's your friend code - send this to your friend:</p>
            <div class="code-container">
                <code id="friend-code"></code>
                <button id="copy-code">Copy Code</button>
            </div>
            <p class="note">After sending the code, you can close this window.</p>
        </div>
    </div>
    <script>

    const REDIRECT_URI = 'https://yuma-dev.github.io/spotify-group';
    const CLIENT_ID = 'bb39de3fd45d476880f0373663e4a751';
    
    async function handleCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state'); // From Spotify callback
        const session = urlParams.get('session'); // From initial invite link
        
        // Store session data if it's coming from the invite link
        if (session) {
            localStorage.setItem('pendingSession', session);
        }
    
        // Get stored session data
        const storedSession = localStorage.getItem('pendingSession');
        
        console.log('Code:', code);
        console.log('State:', state);
        console.log('Session:', session);
        console.log('Stored Session:', storedSession);
    
        if (code && storedSession) {
            // We have both the auth code and session data - create friend code
            const friendCode = btoa(JSON.stringify({
                auth: code,
                session: storedSession,
                timestamp: Date.now()
            }));
    
            // Clear stored session since we don't need it anymore
            localStorage.removeItem('pendingSession');
    
            // Show success screen with the code
            document.querySelector('#loading').classList.add('hidden');
            document.querySelector('#success').classList.remove('hidden');
            
            const codeContainer = document.querySelector('.code-container');
            const codeElement = document.createElement('code');
            codeElement.textContent = friendCode;
            codeContainer.insertBefore(codeElement, codeContainer.firstChild);
            
            // Add copy functionality
            const copyButton = codeContainer.querySelector('button');
            copyButton.addEventListener('click', () => {
                navigator.clipboard.writeText(friendCode);
                copyButton.textContent = 'Copied!';
                setTimeout(() => {
                    copyButton.textContent = 'Copy Code';
                }, 2000);
            });
        } else if (storedSession || session) {
            // Show auth screen - we have session data but need Spotify auth
            document.querySelector('#loading').classList.add('hidden');
            document.querySelector('#auth').classList.remove('hidden');
            
            // Add connect button handler
            document.querySelector('#auth button').addEventListener('click', () => {
                const scopes = [
                    'user-read-private',
                    'user-read-email',
                    'user-read-currently-playing',
                    'user-read-recently-played',
                    'user-top-read',
                    'user-follow-read',
                    'user-library-read',
                    'user-modify-playback-state',
                    'user-read-playback-state',
                    'streaming',
                    'playlist-read-private',
                    'playlist-read-collaborative',
                    'user-library-read'
                ];
                
                const sessionToUse = storedSession || session;
                const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(scopes.join(' '))}&state=${sessionToUse}`;
                window.location.href = authUrl;
            });
        } else {
            // Show error screen - we don't have session data
            document.querySelector('#loading').classList.add('hidden');
            document.querySelector('#error').classList.remove('hidden');
            console.error('No session data available');
        }
    }
    
    // Start the flow when page loads
    window.addEventListener('load', handleCallback);

    </script>
</body>
</html>
